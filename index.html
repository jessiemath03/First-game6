<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Jessie Math ä¸‰å¹´ç´šé™¤æ³•æ¥µç°¡éŠæˆ²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --primary: #ffb703;
      --primary-dark: #fb8500;
      --bg: #fffaf0;
      --text: #222222;
      --accent: #219ebc;
      --danger: #e63946;
      --success: #2a9d8f;
      --card: #ffffff;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow: 0 6px 16px rgba(0,0,0,0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #fff7cc 0, #ffe6d5 45%, #fdf2ff 85%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* HERO + NAV */

    header {
      width: 100%;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0,0,0,0.04);
    }

    .hero-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .hero-avatar-wrapper {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ffd166, #ffb703);
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.18);
    }

    .hero-avatar-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 50%;
      background: transparent;
    }

    .hero-brand-title {
      font-size: 26px;
      letter-spacing: 1px;
      font-weight: 800;
    }

    .hero-brand-sub {
      font-size: 12px;
      color: #6b7280;
    }

    nav {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .nav-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.08);
      background: linear-gradient(135deg, #ffffff, #f9fafb);
      font-size: 13px;
      text-decoration: none;
      color: #374151;
      cursor: pointer;
      transition: 0.15s;
      white-space: nowrap;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    .nav-btn span.icon {
      font-size: 16px;
    }

    .nav-btn.primary {
      background: linear-gradient(135deg, #ffb703, #fb8500);
      border-color: rgba(251,133,0,0.7);
      color: #111827;
      font-weight: 600;
    }

    .nav-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.18);
    }

    .nav-btn.primary:hover {
      color: #ffffff;
    }

    main {
      flex: 1;
      width: 100%;
      max-width: 720px;
      margin: 0 auto;
      padding: 16px;
    }

    /* é é¢åˆ‡æ› */

    .page {
      display: none;
      animation: fadeIn 0.2s ease-out;
    }

    .page.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      padding: 16px 16px 18px;
      border: 1px solid rgba(255,255,255,0.7);
    }

    .title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 13px;
      color: #6b7280;
      line-height: 1.6;
      margin-bottom: 10px;
    }

    .field {
      margin-bottom: 10px;
    }

    label {
      font-size: 13px;
      display: block;
      margin-bottom: 4px;
      color: #374151;
    }

    input[type="text"],
    select {
      width: 100%;
      padding: 8px 10px;
      font-size: 14px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      outline: none;
      background: #fffbeb;
      transition: 0.15s;
    }

    input[type="text"]:focus,
    select:focus {
      border-color: var(--primary-dark);
      box-shadow: 0 0 0 2px rgba(251,133,0,0.35);
      background: #fff7d6;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: 0.12s;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #ffb703, #fb8500);
      color: #1f2937;
      box-shadow: 0 4px 10px rgba(0,0,0,0.22);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.25);
      color: #ffffff;
    }

    .btn-ghost {
      background: #ffffff;
      color: #111827;
      border: 1px solid rgba(148,163,184,0.8);
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    }

    .btn-ghost:hover {
      background: #f9fafb;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #e0f2fe, #bfdbfe);
      color: #1e3a8a;
      border: 1px solid #93c5fd;
      box-shadow: 0 2px 6px rgba(148,163,184,0.6);
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #bfdbfe, #93c5fd);
      transform: translateY(-1px);
    }

    .btn-small {
      padding: 6px 10px;
      font-size: 13px;
    }

    .hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }

    /* PAGE 1 */

    .tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
      margin-bottom: 8px;
    }

    .tag {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #fef9c3;
      border: 1px solid #fde68a;
      color: #854d0e;
    }

    /* PAGE 2 */

    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .flex-1 {
      flex: 1 1 160px;
      min-width: 0;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    .pill-option {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.8);
      font-size: 13px;
      cursor: pointer;
      background: linear-gradient(135deg, #ffffff, #f9fafb);
      color: #111827;
      box-shadow: 0 2px 5px rgba(148,163,184,0.4);
      transition: 0.12s;
    }

    .pill-option:hover {
      transform: translateY(-1px);
    }

    .pill-option.active {
      background: linear-gradient(135deg, #ffb703, #fb8500);
      color: #111827;
      border-color: rgba(251,133,0,0.8);
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    }

    .tiny {
      font-size: 11px;
      color: #6b7280;
      margin-top: 2px;
    }

    .leaderboard {
      margin-top: 10px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148,163,184,0.5);
      max-height: 220px;
      overflow: auto;
      font-size: 12px;
      background: #f9fafb;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(148,163,184,0.25);
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      background: #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .badge-stars {
      font-size: 11px;
      color: #facc15;
    }

    .badge-level {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
    }

    /* PAGE 3 */

    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .stat-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .stat-pill {
      padding: 4px 9px;
      border-radius: 999px;
      background: #eef2ff;
      font-size: 12px;
      box-shadow: 0 2px 5px rgba(148,163,184,0.6);
    }

    .stat-label {
      color: #6b7280;
      margin-right: 4px;
    }

    .stat-value {
      font-weight: 700;
    }

    .stat-time {
      background: #fee2e2;
      color: #b91c1c;
    }

    .stat-time.low {
      background: #fecaca;
      color: #7f1d1d;
    }

    .game-question {
      margin-top: 6px;
      text-align: center;
      padding: 16px 10px 14px;
      border-radius: var(--radius-md);
      background: linear-gradient(135deg, #fff7d6, #ffe4e6);
      box-shadow: 0 3px 8px rgba(148,163,184,0.6);
    }

    .game-q-text {
      font-size: 32px;
      font-weight: 800;
      letter-spacing: 2px;
      margin-bottom: 6px;
      color: #111827;
    }

    .game-q-sub {
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 10px;
    }

    .answer-row {
      display: flex;
      justify-content: center;
      gap: 8px;
      align-items: flex-end;
      flex-wrap: nowrap;
    }

    .answer-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .answer-group input[type="number"] {
      width: 70px;
      padding: 6px 8px;
      font-size: 18px;
      text-align: center;
      border-radius: 10px;
      border: 2px solid #facc15;
      outline: none;
      background: #fffbeb;
      transition: 0.1s;
    }

    .answer-group input[type="number"]:focus {
      box-shadow: 0 0 0 2px rgba(250,204,21,0.5);
    }

    .answer-label {
      font-size: 11px;
      color: #4b5563;
    }

    .feedback {
      margin-top: 6px;
      font-size: 13px;
      min-height: 20px;
      padding: 4px 6px;
      border-radius: 999px;
      display: inline-block;
    }

    .feedback.ok {
      color: #166534;
      background: #dcfce7;
      border: 1px solid #86efac;
    }

    .feedback.bad {
      color: #b91c1c;
      background: #fee2e2;
      border: 1px solid #fecaca;
    }

    .control-row {
      margin-top: 12px;
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* overlay */

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }

    .overlay.visible {
      display: flex;
    }

    .overlay-card {
      width: min(90%, 360px);
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.3);
      padding: 16px;
      text-align: center;
    }

    .overlay-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .overlay-text {
      font-size: 13px;
      color: #4b5563;
      line-height: 1.6;
      margin-bottom: 10px;
    }

    .overlay-actions {
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* RWD */

    @media (max-width: 640px) {
      header { padding-inline: 10px; }
      .hero-avatar-wrapper { width: 52px; height: 52px; }
      .hero-brand-title { font-size: 22px; }
      .hero-brand-sub { display: none; }
      nav .nav-btn span.text { display: none; }
    }

    @media (max-width: 480px) {
      main { padding: 12px; }
      .card { padding: 14px 14px 16px; }
      .game-q-text { font-size: 26px; }
      .answer-group input[type="number"] { width: 64px; }
    }
  </style>
</head>
<body>
  <!-- HERO -->
  <header>
    <div class="hero-left">
      <div class="hero-avatar-wrapper">
        <img src="JESSIEMATH-Q.png" alt="Jessie Math Avatar" />
      </div>
      <div>
        <div class="hero-brand-title">Jessie Math</div>
        <div class="hero-brand-sub">ä¸‰å¹´ç´šé™¤æ³• Â· U6 éŠæˆ²</div>
      </div>
    </div>
    <nav>
      <a class="nav-btn" href="https://jessiemath0703-chu.github.io/website2/" target="_blank" rel="noopener noreferrer">
        <span class="icon">ğŸ </span><span class="text">é¦–é </span>
      </a>
      <a class="nav-btn" href="https://jessiemath0703-chu.github.io/Game-Lobby/" target="_blank" rel="noopener noreferrer">
        <span class="icon">ğŸ®</span><span class="text">éŠæˆ²å¤§å»³</span>
      </a>
      <a class="nav-btn primary" href="https://jessiemath0703-chu.github.io/Game-Lobby/#g3-u6" target="_blank" rel="noopener noreferrer">
        <span class="icon">â—</span><span class="text">ä¸‰å¹´ç´šé™¤æ³•</span>
      </a>
    </nav>
  </header>

  <main>
    <!-- PAGE 1 -->
    <section class="page active" id="page-1">
      <div class="card">
        <div class="title">è¼¸å…¥åå­—ï¼Œæº–å‚™é–‹å§‹</div>
        <div class="subtitle">
          60 ç§’æ¥µé€Ÿä¸‰å¹´ç´šé™¤æ³•æŒ‘æˆ°ï¼šç·´ç¿’ 0 å’Œ 1 çš„é™¤æ³•ã€å¹³å‡åˆ†èˆ‡åˆ†çµ„ã€ç›´å¼å’Œé¤˜æ•¸ã€‚  
          éŠæˆ²æœƒè‡ªå‹•è¨ˆæ™‚èˆ‡è¨ˆåˆ†ï¼ŒçµæŸå¾Œå¯ä»¥æ¯”è¼ƒæ’è¡Œæ¦œã€‚
        </div>
        <div class="tag-row">
          <span class="tag">æ¯å›åˆ 60 ç§’</span>
          <span class="tag">ç­”å°åŠ ç§’</span>
          <span class="tag">ç­”éŒ¯æ‰£ç§’</span>
          <span class="tag">Combo é€£æ“Š</span>
          <span class="tag">â˜… æ˜Ÿç­‰è©•åƒ¹</span>
        </div>
        <div class="field">
          <label for="name-input">ç©å®¶å§“åï¼ˆå¿…å¡«ï¼‰</label>
          <input type="text" id="name-input" placeholder="è«‹è¼¸å…¥ä½ çš„åå­—ï¼Œä¾‹å¦‚ï¼šå°æ¨‚" />
          <div class="hint" id="name-hint">
            åå­—æœƒç”¨åœ¨æ’è¡Œæ¦œï¼Œåªå„²å­˜åœ¨ä½ çš„è£ç½®ï¼Œä¸æœƒä¸Šå‚³ç¶²è·¯ã€‚
          </div>
        </div>
        <button class="btn btn-primary" id="btn-to-menu">ä¸‹ä¸€æ­¥ï¼šé¸é—œå¡èˆ‡é›£åº¦</button>
      </div>
    </section>

    <!-- PAGE 2 -->
    <section class="page" id="page-2">
      <div class="card">
        <div class="title">ä¸»é¸å–®ï¼šé¸é—œå¡èˆ‡é›£åº¦</div>
        <div class="subtitle" id="menu-subtitle"></div>

        <div class="flex-row">
          <div class="flex-1">
            <div class="field">
              <label>é—œå¡ï¼ˆä¸‰å€‹éšæ®µï¼‰</label>
              <div class="pill-row" id="level-row">
                <button class="pill-option" data-level="1">ç¬¬ 1 é—œ Â· 0 å’Œ 1</button>
                <button class="pill-option" data-level="2">ç¬¬ 2 é—œ Â· å¹³åˆ†èˆ‡é¤˜æ•¸</button>
                <button class="pill-option" data-level="3">ç¬¬ 3 é—œ Â· ç›´å¼æ··åˆ</button>
              </div>
              <div class="tiny">å¾ç°¡å–®åˆ°æœ‰é¤˜æ•¸å†åˆ°ç›´å¼ï¼Œæ¨è–¦ç…§é †åºç©ä¸€æ¬¡ã€‚</div>
            </div>
            <div class="field">
              <label>é€Ÿåº¦ / é›£æ˜“åº¦</label>
              <div class="pill-row" id="diff-row">
                <button class="pill-option" data-diff="easy">æ–°æ‰‹ Â· +5s / -3s</button>
                <button class="pill-option" data-diff="normal">æŒ‘æˆ° Â· +5s / -5s</button>
                <button class="pill-option" data-diff="hard">è¶…å¿«æ‰‹ Â· +4s / -6s</button>
              </div>
              <div class="tiny">ç­”å°åŠ ç§’ã€ç­”éŒ¯æ‰£ç§’ï¼Œè¶Šé›£ç¯€å¥è¶Šå¿«ã€‚</div>
            </div>
            <button class="btn btn-primary" id="btn-to-game">é–‹å§‹éŠæˆ²</button>
            <button class="btn btn-ghost btn-small" id="btn-back-name">è¿”å›å§“åé </button>
          </div>

          <div class="flex-1">
            <div class="field">
              <label>æœ¬æ©Ÿæ’è¡Œæ¦œï¼ˆå‰ 10 åï¼‰</label>
              <div class="leaderboard">
                <table>
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>ç©å®¶</th>
                      <th>åˆ†æ•¸</th>
                      <th>æ˜Ÿç­‰</th>
                      <th>é—œå¡</th>
                      <th>é›£åº¦</th>
                    </tr>
                  </thead>
                  <tbody id="leaderboard-body">
                    <tr>
                      <td colspan="6" style="text-align:center;color:#9ca3af;font-size:11px;">
                        ç›®å‰å°šç„¡ç´€éŒ„ï¼Œå…ˆç©ä¸€å±€å§ã€‚
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="tiny">æ’è¡Œæ¦œåªå­˜åœ¨æœ¬è£ç½®ï¼Œé‡æ–°æ•´ç†ç¶²é ä»æœƒä¿ç•™ã€‚</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE 3 -->
    <section class="page" id="page-3">
      <div class="card">
        <div class="game-header">
          <div class="stat-row">
            <div class="stat-pill stat-time" id="time-pill">
              <span class="stat-label">æ™‚é–“</span>
              <span class="stat-value"><span id="time-left">60</span>s</span>
            </div>
            <div class="stat-pill">
              <span class="stat-label">åˆ†æ•¸</span>
              <span class="stat-value" id="score">0</span>
            </div>
            <div class="stat-pill" id="combo-pill" style="display:none;">
              <span class="stat-label">Combo</span>
              <span class="stat-value" id="combo">0</span>
            </div>
          </div>
          <div class="control-row" style="margin-top:0;">
            <button class="btn btn-secondary btn-small" id="btn-game-restart">é‡ä¾†</button>
            <button class="btn btn-secondary btn-small" id="btn-game-pause">æš«åœ</button>
            <button class="btn btn-primary btn-small" id="btn-game-menu">å›ä¸»é¸å–®</button>
          </div>
        </div>

        <div class="game-question">
          <div class="game-q-text" id="q-text">? Ã· ? = ? ...</div>
          <div class="game-q-sub" id="q-sub">é¡Œç›®æœƒä¾é—œå¡è‡ªå‹•å‡ºé¡Œï¼Œè«‹è¼¸å…¥å•†èˆ‡é¤˜æ•¸ã€‚</div>

          <div class="answer-row">
            <div class="answer-group">
              <input type="number" id="ans-quotient" placeholder="å•†" />
              <div class="answer-label">å•†</div>
            </div>
            <div class="answer-group">
              <input type="number" id="ans-remainder" placeholder="é¤˜" />
              <div class="answer-label">é¤˜æ•¸</div>
            </div>
            <button class="btn btn-primary btn-small" id="btn-submit">é€å‡º</button>
          </div>
          <div class="feedback" id="feedback"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- çµç®— overlay -->
  <div class="overlay" id="result-overlay">
    <div class="overlay-card">
      <div class="overlay-title">æœ¬å±€çµæŸ</div>
      <div class="overlay-text" id="result-text"></div>
      <div class="overlay-actions">
        <button class="btn btn-primary" id="btn-save-score">å­˜åˆ°æ’è¡Œæ¦œ</button>
        <button class="btn btn-ghost" id="btn-close-result">ä¸ç”¨ï¼Œå›ä¸»é¸å–®</button>
      </div>
    </div>
  </div>

  <!-- æš«åœ overlay -->
  <div class="overlay" id="pause-overlay">
    <div class="overlay-card">
      <div class="overlay-title">å·²æš«åœ</div>
      <div class="overlay-text">
        è¨ˆæ™‚æš«åœä¸­ï¼Œé¡Œç›®å·²é–å®šã€‚  
        ä½ å¯ä»¥ç¹¼çºŒéŠæˆ²ï¼Œæˆ–çµæŸæœ¬å±€å›ä¸»é¸å–®ï¼ˆæœ¬å±€ä¸æœƒå¯«å…¥æ’è¡Œæ¦œï¼‰ã€‚
      </div>
      <div class="overlay-actions">
        <button class="btn btn-primary" id="btn-resume">ç¹¼çºŒ</button>
        <button class="btn btn-ghost" id="btn-pause-back-menu">å›ä¸»é¸å–®</button>
      </div>
    </div>
  </div>

  <script>
    const state = {
      name: "",
      level: null,
      difficulty: null,
      inGame: false,
      timeLeft: 60,
      score: 0,
      combo: 0,
      timerId: null,
      question: null,
      allowAnswer: false,
      leaderboard: [],
      pendingScore: null,
      diffCfg: {
        easy:   { plus: 5, minus: 3 },
        normal: { plus: 5, minus: 5 },
        hard:   { plus: 4, minus: 6 }
      }
    };

    const page1 = document.getElementById("page-1");
    const page2 = document.getElementById("page-2");
    const page3 = document.getElementById("page-3");

    const nameInput = document.getElementById("name-input");
    const nameHint = document.getElementById("name-hint");
    const btnToMenu = document.getElementById("btn-to-menu");

    const menuSubtitle = document.getElementById("menu-subtitle");
    const levelRow = document.getElementById("level-row");
    const diffRow = document.getElementById("diff-row");
    const btnToGame = document.getElementById("btn-to-game");
    const btnBackName = document.getElementById("btn-back-name");
    const leaderboardBody = document.getElementById("leaderboard-body");

    const timeLeftEl = document.getElementById("time-left");
    const timePill = document.getElementById("time-pill");
    const scoreEl = document.getElementById("score");
    const comboEl = document.getElementById("combo");
    const comboPill = document.getElementById("combo-pill");

    const qText = document.getElementById("q-text");
    const qSub = document.getElementById("q-sub");
    const ansQ = document.getElementById("ans-quotient");
    const ansR = document.getElementById("ans-remainder");
    const btnSubmit = document.getElementById("btn-submit");
    const feedback = document.getElementById("feedback");

    const btnGameRestart = document.getElementById("btn-game-restart");
    const btnGamePause = document.getElementById("btn-game-pause");
    const btnGameMenu = document.getElementById("btn-game-menu");

    const resultOverlay = document.getElementById("result-overlay");
    const resultText = document.getElementById("result-text");
    const btnSaveScore = document.getElementById("btn-save-score");
    const btnCloseResult = document.getElementById("btn-close-result");

    const pauseOverlay = document.getElementById("pause-overlay");
    const btnResume = document.getElementById("btn-resume");
    const btnPauseBackMenu = document.getElementById("btn-pause-back-menu");

    function showPage(n) {
      [page1, page2, page3].forEach((p, i) => {
        p.classList.toggle("active", i === n - 1);
      });
    }

    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function choose(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function formatStars(score) {
      let stars = 1;
      if (score >= 200) stars = 3;
      else if (score >= 120) stars = 2;
      const icon = "â˜…".repeat(stars) + "â˜†".repeat(3 - stars);
      return { stars, icon };
    }

    function resetGameValues() {
      clearInterval(state.timerId);
      state.timerId = null;
      state.timeLeft = 60;
      state.score = 0;
      state.combo = 0;
      state.question = null;
      state.allowAnswer = false;
      timeLeftEl.textContent = "60";
      timePill.classList.remove("low");
      scoreEl.textContent = "0";
      comboEl.textContent = "0";
      comboPill.style.display = "none";
      ansQ.value = "";
      ansR.value = "";
      feedback.textContent = "";
      feedback.className = "feedback";
      qText.textContent = "? Ã· ? = ? ...";
      qSub.textContent = "é¡Œç›®æœƒä¾é—œå¡è‡ªå‹•å‡ºé¡Œï¼Œè«‹è¼¸å…¥å•†èˆ‡é¤˜æ•¸ã€‚";
    }

    function generateQuestion() {
      const level = state.level;
      const q = { a: 0, b: 0, quotient: 0, remainder: 0 };

      if (level === 1) {
        const type = choose(["divBy1", "divIs1", "zeroNumerator"]);
        if (type === "divBy1") {
          const a = randomInt(0, 9);
          q.a = a; q.b = 1; q.quotient = a; q.remainder = 0;
          qSub.textContent = "ä»»ä½•æ•¸é™¤ä»¥ 1ï¼Œå•†æ˜¯åŸæœ¬çš„æ•¸ï¼Œæ²’æœ‰é¤˜æ•¸ã€‚";
        } else if (type === "divIs1") {
          const b = randomInt(1, 9);
          q.a = b; q.b = b; q.quotient = 1; q.remainder = 0;
          qSub.textContent = "ä¸€æ¨£å¤šçš„äººåˆ†ä¸€æ¨£å¤šçš„ç³–ï¼Œæ¯äºº 1 é¡†ã€‚";
        } else {
          const b = randomInt(1, 9);
          q.a = 0; q.b = b; q.quotient = 0; q.remainder = 0;
          qSub.textContent = "0 é¡†ç³–åˆ†çµ¦å¹¾å€‹äººï¼Œæ¯äººéƒ½æ˜¯ 0 é¡†ã€‚";
        }
      } else if (level === 2) {
        const base = randomInt(10, 40);
        const b = randomInt(2, 9);
        let a = base;
        if (a % b === 0 && Math.random() < 0.5) a += 1;
        q.a = a;
        q.b = b;
        q.quotient = Math.floor(a / b);
        q.remainder = a % b;
        qSub.textContent = "å¹³å‡åˆ†æˆ–åˆ†çµ„ï¼Œæœ‰æ™‚æœƒå‰©ä¸‹ä¸€äº›é¤˜æ•¸ã€‚";
      } else {
        const b = randomInt(2, 9);
        const quotient = randomInt(3, 12);
        const rem = randomInt(0, b - 1);
        q.a = quotient * b + rem;
        q.b = b;
        q.quotient = quotient;
        q.remainder = rem;
        qSub.textContent = "å¯ä»¥æ‹¿ç´™ç­†ç•«ç›´å¼ï¼Œå¾é«˜ä½é–‹å§‹é™¤ã€‚";
      }

      state.question = q;
      qText.textContent = `${q.a} Ã· ${q.b}`;
      ansQ.value = "";
      ansR.value = "";
      feedback.textContent = "";
      feedback.className = "feedback";
      state.allowAnswer = true;
      ansQ.focus();
    }

    function startTimer() {
      clearInterval(state.timerId);
      state.timerId = setInterval(() => {
        if (!state.inGame) return;
        state.timeLeft -= 1;
        if (state.timeLeft < 0) state.timeLeft = 0;
        timeLeftEl.textContent = state.timeLeft;
        if (state.timeLeft <= 10) {
          timePill.classList.add("low");
        }
        if (state.timeLeft <= 0) {
          endGame(false);
        }
      }, 1000);
    }

    function applyResult(correct) {
      if (!state.inGame) return;
      const cfg = state.diffCfg[state.difficulty || "normal"];

      if (correct) {
        state.combo += 1;
        const gain = 10 * Math.max(1, state.combo);
        state.score += gain;
        state.timeLeft += cfg.plus;
        if (state.timeLeft > 120) state.timeLeft = 120;
        scoreEl.textContent = state.score;
        timeLeftEl.textContent = state.timeLeft;

        if (state.combo >= 2) {
          comboPill.style.display = "inline-flex";
          comboEl.textContent = state.combo;
        } else {
          comboPill.style.display = "none";
          comboEl.textContent = "0";
        }

        const q = state.question;
        feedback.textContent = `ç­”å°ï¼${q.a} Ã· ${q.b} = ${q.quotient} â€¦â€¦ é¤˜æ•¸ ${q.remainder}ã€‚ +${gain} åˆ†ï¼Œæ™‚é–“ +${cfg.plus} ç§’ï¼ŒCombo x${state.combo}`;
        feedback.className = "feedback ok";
      } else {
        state.timeLeft -= cfg.minus;
        if (state.timeLeft < 0) state.timeLeft = 0;
        timeLeftEl.textContent = state.timeLeft;
        state.combo = 0;
        comboPill.style.display = "none";
        comboEl.textContent = "0";

        const q = state.question;
        feedback.textContent = `å†æƒ³æƒ³ï½æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${q.a} Ã· ${q.b} = ${q.quotient} â€¦â€¦ é¤˜æ•¸ ${q.remainder}ã€‚æ™‚é–“ -${cfg.minus} ç§’ï¼ˆä¸æ‰£åˆ†ï¼‰ã€‚`;
        feedback.className = "feedback bad";
      }

      if (state.timeLeft <= 10) timePill.classList.add("low");
      else timePill.classList.remove("low");

      if (state.timeLeft <= 0) {
        endGame(false);
      } else if (correct) {
        setTimeout(() => { if (state.inGame) generateQuestion(); }, 450);
      } else {
        setTimeout(() => { if (state.inGame) generateQuestion(); }, 700);
      }
    }

    function submitAnswer() {
      if (!state.inGame || !state.allowAnswer || !state.question) return;
      const qAns = parseInt(ansQ.value, 10);
      const rAns = parseInt(ansR.value, 10);
      if (isNaN(qAns) || isNaN(rAns)) {
        feedback.textContent = "è«‹è¼¸å…¥å•†èˆ‡é¤˜æ•¸ï¼ˆå…©å€‹éƒ½è¦å¡«ï¼‰ã€‚";
        feedback.className = "feedback bad";
        return;
      }
      state.allowAnswer = false;
      const q = state.question;
      const correct = qAns === q.quotient && rAns === q.remainder;
      applyResult(correct);
    }

    function startGame() {
      if (!state.name || !state.level || !state.difficulty) return;
      resetGameValues();
      state.inGame = true;
      generateQuestion();
      startTimer();
      showPage(3);
    }

    function restartGame() {
      if (!state.level || !state.difficulty) return;
      startGame();
    }

    function endGame(fromUser) {
      clearInterval(state.timerId);
      state.timerId = null;
      if (!state.inGame && !fromUser) return;
      state.inGame = false;
      state.allowAnswer = false;

      const { stars, icon } = formatStars(state.score);
      const levelName = `ç¬¬ ${state.level || "?"} é—œ`;
      let diffName = "æŒ‘æˆ°";
      if (state.difficulty === "easy") diffName = "æ–°æ‰‹";
      if (state.difficulty === "hard") diffName = "è¶…å¿«æ‰‹";

      resultText.innerHTML =
        `é€™å±€çµæŸå›‰ï¼<br>` +
        `åˆ†æ•¸ï¼š<strong>${state.score}</strong> åˆ†<br>` +
        `æ˜Ÿç­‰ï¼š<span style="color:#eab308;font-size:18px;">${icon}</span><br>` +
        `é—œå¡ï¼š${levelName} Â· é›£åº¦ï¼š${diffName}`;
      resultOverlay.classList.add("visible");

      state.pendingScore = {
        name: state.name,
        score: state.score,
        stars,
        level: state.level,
        difficulty: state.difficulty
      };
    }

    function backToMenuNoSave() {
      state.pendingScore = null;
      resultOverlay.classList.remove("visible");
      resetGameValues();
      showPage(2);
    }

    function pauseGame() {
      if (!state.inGame) return;
      state.inGame = false;
      clearInterval(state.timerId);
      state.timerId = null;
      pauseOverlay.classList.add("visible");
    }

    function resumeGame() {
      if (state.timeLeft <= 0) return;
      pauseOverlay.classList.remove("visible");
      state.inGame = true;
      startTimer();
    }

    function loadLeaderboard() {
      try {
        const raw = localStorage.getItem("jm_division_leaderboard");
        state.leaderboard = raw ? JSON.parse(raw) : [];
      } catch {
        state.leaderboard = [];
      }
      renderLeaderboard();
    }

    function saveLeaderboard() {
      try {
        localStorage.setItem("jm_division_leaderboard", JSON.stringify(state.leaderboard));
      } catch {}
    }

    function renderLeaderboard() {
      leaderboardBody.innerHTML = "";
      const list = [...state.leaderboard].sort((a, b) => b.score - a.score).slice(0, 10);
      if (!list.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 6;
        td.style.textAlign = "center";
        td.style.color = "#9ca3af";
        td.style.fontSize = "11px";
        td.textContent = "ç›®å‰å°šç„¡ç´€éŒ„ï¼Œå…ˆç©ä¸€å±€å§ã€‚";
        tr.appendChild(td);
        leaderboardBody.appendChild(tr);
        return;
      }
      list.forEach((item, i) => {
        const tr = document.createElement("tr");
        const tdRank = document.createElement("td");
        const tdName = document.createElement("td");
        const tdScore = document.createElement("td");
        const tdStars = document.createElement("td");
        const tdLevel = document.createElement("td");
        const tdDiff = document.createElement("td");

        tdRank.textContent = i + 1;
        tdName.textContent = item.name;
        tdScore.textContent = item.score;
        tdStars.innerHTML = `<span class="badge-stars">${"â˜…".repeat(item.stars)}${"â˜†".repeat(3 - item.stars)}</span>`;
        tdLevel.innerHTML = `<span class="badge-level">ç¬¬ ${item.level} é—œ</span>`;
        let diff = "æŒ‘æˆ°";
        if (item.difficulty === "easy") diff = "æ–°æ‰‹";
        if (item.difficulty === "hard") diff = "è¶…å¿«æ‰‹";
        tdDiff.textContent = diff;

        tr.appendChild(tdRank);
        tr.appendChild(tdName);
        tr.appendChild(tdScore);
        tr.appendChild(tdStars);
        tr.appendChild(tdLevel);
        tr.appendChild(tdDiff);
        leaderboardBody.appendChild(tr);
      });
    }

    function addScoreToLeaderboard(entry) {
      if (!entry) return;
      state.leaderboard.push(entry);
      saveLeaderboard();
      renderLeaderboard();
    }

    btnToMenu.addEventListener("click", () => {
      const name = nameInput.value.trim();
      if (!name) {
        alert("è«‹å…ˆè¼¸å…¥åå­—ã€‚");
        return;
      }
      state.name = name;
      nameHint.textContent = `å—¨ï¼Œ${name}ï¼æ¥ä¸‹ä¾†é¸é—œå¡èˆ‡é›£åº¦ï¼Œå†é–‹å§‹éŠæˆ²ã€‚`;
      menuSubtitle.textContent = `${name}ï¼Œè«‹é¸æ“‡è¦æŒ‘æˆ°çš„é—œå¡å’Œé€Ÿåº¦ã€‚`;
      showPage(2);
    });

    nameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") btnToMenu.click();
    });

    levelRow.addEventListener("click", (e) => {
      const btn = e.target.closest(".pill-option");
      if (!btn) return;
      state.level = parseInt(btn.dataset.level, 10);
      levelRow.querySelectorAll(".pill-option").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
    });

    diffRow.addEventListener("click", (e) => {
      const btn = e.target.closest(".pill-option");
      if (!btn) return;
      state.difficulty = btn.dataset.diff;
      diffRow.querySelectorAll(".pill-option").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
    });

    btnToGame.addEventListener("click", () => {
      if (!state.level || !state.difficulty) {
        alert("è«‹å…ˆé¸æ“‡é—œå¡èˆ‡é€Ÿåº¦ï¼ˆé›£æ˜“åº¦ï¼‰ã€‚");
        return;
      }
      startGame();
    });

    btnBackName.addEventListener("click", () => {
      showPage(1);
    });

    btnSubmit.addEventListener("click", submitAnswer);
    ansQ.addEventListener("keydown", (e) => { if (e.key === "Enter") submitAnswer(); });
    ansR.addEventListener("keydown", (e) => { if (e.key === "Enter") submitAnswer(); });

    btnGameRestart.addEventListener("click", () => {
      if (confirm("é‡æ–°é–‹å§‹æœ¬é—œæœ¬é›£åº¦ï¼Ÿç›®å‰åˆ†æ•¸æœƒæ­¸é›¶ã€‚")) {
        restartGame();
      }
    });

    btnGamePause.addEventListener("click", () => {
      pauseGame();
    });

    btnGameMenu.addEventListener("click", () => {
      if (confirm("ç›´æ¥å›ä¸»é¸å–®ï¼Ÿæœ¬å±€ä¸æœƒå¯«å…¥æ’è¡Œæ¦œã€‚")) {
        endGame(true);
        state.pendingScore = null;
        resultOverlay.classList.remove("visible");
        resetGameValues();
        showPage(2);
      }
    });

    btnResume.addEventListener("click", () => {
      resumeGame();
    });

    btnPauseBackMenu.addEventListener("click", () => {
      pauseOverlay.classList.remove("visible");
      resetGameValues();
      showPage(2);
    });

    btnSaveScore.addEventListener("click", () => {
      addScoreToLeaderboard(state.pendingScore);
      state.pendingScore = null;
      resultOverlay.classList.remove("visible");
      resetGameValues();
      showPage(2);
    });

    btnCloseResult.addEventListener("click", () => {
      state.pendingScore = null;
      resultOverlay.classList.remove("visible");
      resetGameValues();
      showPage(2);
    });

    loadLeaderboard();
  </script>
</body>
</html>

